<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
	* {
		box-sizing: border-box;
	}

	body {
		background-color: black;
		margin: 0;
	}
	
	/*Created a header container to hold buttons at the top*/
	.header {
		padding: 10px;
		<!-- background-color: blue; -->
		margin: 0px 0px 0px;
	}
	
	/*Button group for creating the buttons at top of page*/
	/*Same button group from the main page*/
	.button-group button {
		background-color: #D3D3D3; /*Makes Gray background*/
		border:  0px #D3D3D3;  /*Border around boxes is Gray*/
		color: black; /* White text */
		padding: 10px 10px; /* Some padding */
		margin: 0;  /* Created space between buttons */
		font-family: Arial Black, Times, serif; /* sets font */
		font-size:  16px;	/* Sets size */
		font-weight:  normal;	/*Sets normal or bold */
		text-align: center;	/* Aligns to center of button */
		cursor: pointer; /* Pointer/hand icon */
		width: 15%; /* Set a width if needed */
		display: inline-block;
	}

	.button-group button:not(:last-child) {
		border-right: none; /* Prevent double borders */
	}

	/* Add a background color on hover */
	.button-group button:hover {
		background-color: #3e8e41;
	}
	
	.column-left {
		background-color: #A9A9A9 !important; //makes Gray background
		padding: 1%;
		margin: 1%;
		width: 50%;
		height: 95%;
		left: .5%;
		display: inline-block;
		text-align:;
		position: absolute;
	}
	
	.column-right {
		background-color: #A9A9A9 !important; //makes Gray background
		padding: 1%;
		margin: 1%;
		width: 35%;
		height: 95%;
		right: .5%;
		display: inline-block;
		text-align: center;
		position: absolute;
	}
	
	.row:after {
		content: "";
		display: table;
		clear: both;
	}
	
	/*Adding to left container*/
	/*Add buttons to the left container*/
	.button-group2 button {
		background-color: black; /*Makes Gray background*/
		border:  1% #D3D3D3;  /*Border around boxes is Gray*/
		color: white; /* White text */
		padding: 20px 50px; /* Some padding */
		margin: 17px;  /* Created space between buttons */
		margin-left: 15%;
		font-family: Arial Black, Times, serif; /* sets font */
		font-size:  20px;	/* Sets size */
		font-weight:  normal;	/*Sets normal or bold */
		text-align: center;	/* Aligns to center of button */
		cursor: pointer; /* Pointer/hand icon */
		width: 65%; /* Set a width if needed */
		display: block;
	}

	.button-group2 button:not(:last-child) {
		border-right: none; /* Prevent double borders */
	}

	/* Add a background color on hover */
	.button-group2 button:focus {
		background-color: green;
	}
	
	.add-tip button{
		background-color: black; /*Makes Gray background*/
		border:  1% #D3D3D3;  /*Border around boxes is Gray*/
		color: white; /* White text */
		padding: 20px 10px; /* Some padding */
		margin-left: 13%;  /* Created space between buttons */
		font-family: Arial Black, Times, serif; /* sets font */
		font-size:  12px;	/* Sets size */
		font-weight:  normal;	/*Sets normal or bold */
		text-align: center;	/* Aligns to center of button */
		cursor: pointer; /* Pointer/hand icon */
		width: 18%; /* Set a width if needed */
		display: inline-block;
		margin-top: 0%;
		margin-left: 75%;
		bottom: 20%;
		position: absolute;
	}
	
	
	/* Add a background color on click */
	.add-tip button:focus {
		background-color: green;
	}
	
	.rewards-button button {
		background-color: black; /*Makes Gray background*/
		border:  1% #D3D3D3;  /*Border around boxes is Gray*/
		color: white; /* White text */
		padding: 20px 10px; /* Some padding */
		margin-left: 13%;  /* Created space between buttons */
		font-family: Arial Black, Times, serif; /* sets font */
		font-size:  12px;	/* Sets size */
		font-weight:  normal;	/*Sets normal or bold */
		text-align: center;	/* Aligns to center of button */
		cursor: pointer; /* Pointer/hand icon */
		width: 30%; /* Set a width if needed */
		display: inline-block;
	}

	/* Add a background color on click */
	.rewards-button button:focus {
		background-color: green;
	}
	

	/*Create an input for tips*/
	input {
		margin: 10px 60px;
		width: 150px;
	}

	label {
		margin: 0px 0px 0px;
	}
	
	h2 {
		margin: 30px;
		text-align: center;
	}
	
	@media screen and (max-width: 600px){
		.column {
			width: 100%;
		}
	}
	
	.slidecontainer {
		float: left;
		width: 100%;
		background-color: none;
		margin: 0 auto;
		right: 0%;
		text-indent: 5%;
	}

	.slider {
		-webkit-appearance: none;
		width: 50%;
		height: 25px;
		background: #d3d3d3;
		position: absolute;
		left: 15%;
		outline: none;
		opacity: 1;
		-webkit-transition: .2s;
		transition: opacity .2s;
	}

	.slider:hover {
		opacity: 1;
	}

	.slider::-webkit-slider-thumb {
		-webkit-appearance: none;
		appearance: none;
		width: 25px;
		height: 25px;
		background: #4CAF50;
		cursor: pointer;
	}

	.slider::-moz-range-thumb {
		width: 25px;
		height: 25px;
		background: #4CAF50;
		cursor: pointer;
	}
	
	/* Add styles to the form container */
	.split-pay-container {
		max-width: 500px;
		padding: 10px;
		background-color: white;
	}
	
	/* Rewards member popup*/
	.rewards-login {
		display: none;
		position: fixed;
		bottom: 25%;
		right: 35%;
		border: 3px solid #f1f1f1;
		z-index: 9;
	}

	/* Add styles to the form container */
	.form-container {
		max-width: 300px;
		padding: 10px;
		background-color: green;
	}

	.form-container input[type=text], .form-container input[type=password] {
		width: 100%;
		padding: 15px;
		margin: 5px 0 22px 0;
		border: none;
		background: #f1f1f1;
	}

	.form-container input[type=text]:focus, .form-container input[type=password]:focus {
		background-color: #ddd;
		outline: none;
	}

	/* Set a style for the submit/login button */
	.form-container .button {
		background-color: gray;
		color: white;
		padding: 16px 20px;
		border: none;
		cursor: pointer;
		width: 100%;
		margin-bottom:10px;
		opacity: 0.8;
	}


	.form-container .cancel {
		background-color: gray;
	}

	.form-container .button:hover, .open-button:hover {
		opacity: 1;
	}
	
	/****Credit Card****/
	.credit-popup {
		display: none;
		position: fixed;
		bottom: 50%;
		right: 5%;
		border: 3px solid #f1f1f1;
		z-index: 9;
	}
	
	/* Add styles to the form container */
	.credit-container {
		max-width: 100%;
		padding: 10px;
		background-color: green;
	}

	.credit-container input[type=text], .form-container input[type=password] {
		width: 100%;
		padding: 15px;
		margin: 5px 0 22px 0;
		border: none;
		background: #f1f1f1;
	}

	.credit-container input[type=text]:focus, .form-container input[type=password]:focus {
		background-color: #ddd;
		outline: none;
	}

	/* Set a style for the submit/login button */
	.credit-container .button {
		background-color: gray;
		color: white;
		padding: 16px 20px;
		border: none;
		cursor: pointer;
		width: 100%;
		margin-bottom:10px;
		opacity: 0.8;
	}


	.credit-container .cancel {
		background-color: gray;
	}

	.credit-container .button:hover, .open-button:hover {
		opacity: 1;
	}

	
</style>

	<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>
    <!--changed to https://... below to remove error-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	
<script>
	//Global payment method selection 0 == card, 1 == cash
	var payment_method;
	//Global paymet amount to be sent to receipt
	var payment_amount;
	var table = 0;
	
	window.addEventListener('message', master_listener, false);
	function master_listener(message) {
		table = message.data; // sample table number from parent document
		
		var url = 'http://159.89.238.181:8080/api/orders/table?table='.concat(table);
		$.ajax({
			url: url,
			type: 'get',
			dataType: 'JSON',
			success: function(response) {			
				if (response.status >= 5) {
					window.history.back();
					alert("I'm sorry, you have no unpaid orders at this time");
				}
				updateReceipt(response); // just the first order we get	
			}
		});
	}
	
	//funciton passed its parameter from button onclick below
	function updatePaymentMethod(){
		//establish an iframe variable
		var target = document.getElementById("receipt_screen");
		
		var credit = $("#select_card");
		credit.click( function() {		//when credit card button clicked assign a payment method == 0			
			payment_method = "card";
			target.contentWindow.postMessage(payment_method, '*');
		});
		
		var cash = $("#select_cash");
		cash.click( function() {		//when cash button clicked assign a payment method == 1
			payment_method = "cash";
			target.contentWindow.postMessage(payment_method, '*');
		});
	}

	//send notification to servers wanting to pay with cash
	function sendCashNotification() {
		var response = confirm("Are you sure you wish to pay cash for this order?");
	
		if(response === true){
			//Create a message to send to notifications page
			var message = {
				table: table,
				variant: 6,
				details: "customers wish to pay with cash."
			};
		
			//console.log(JSON.stringify(message));
			$.post('http://159.89.238.181:8080/api/notifications', JSON.stringify(message), function(response){
				var status = JSON.parse(response);				
				if(status.code != 200){
					alert(status.message);
					//console.log(status.message);
				} else {
					var url = 'http://159.89.238.181:8080/api/orders/status?table=' + table + '&status=5'; // signal that this order is now complete
					console.log(url);
					$.post(url, function() {
						window.history.back();
					});
				}
			});
		}	
	}
	
	//pay to system via credit card
	function sendCreditCardNotification(){
		var response = confirm("Are you sure you wish to pay with a card for this order?");
	
		if(response === true){
			//Create a message to send to notifications page
			var message = {
				table: table,
				variant: 6,
				details: "customer payed with credit card*-."
			};
			
			$.post('http://159.89.238.181:8080/api/notifications', JSON.stringify(message), function(response){
				var status = JSON.parse(response);				
				if(status.code != 200){
					alert(status.message);
					//console.log(status.message);
				} else {
					var url = 'http://159.89.238.181:8080/api/orders/status?table=' + table + '&status=5'; // signal that this order is now complete
					console.log(url);
					$.post(url, function() {
						window.history.back();
					});
				}
				
			});
		}	
	}
	
	//Function to open credit card form for payment
	function openFormCreditCard() {
		document.getElementById("creditInfo").style.display = "block";
	}
	
	//Function to close the credit card form after submitting
	function closeFormCreditCard() {
		//target the iframe to submit charge amount
		var target = document.getElementById("receipt_screen");

		//click function to submit the amount
		var submit = $("#submitAmnt-button");
		var amnt = document.getElementById("creditInfo");
		payment_amount = amnt.value;
		console.log("amnt variable");
		console.log(payment_amount);
		submit.click( function(){
	
		});
	
		document.getElementById("creditInfo").style.display = "none";
	}

	function setup() {
		var toggle = {
			type: "show"
		};
		parent.window.postMessage(toggle, "*");
		var getTable = {type: "table"};
		parent.window.postMessage(getTable, "*");
	}
	
	function goRewards() {
		var message = {
			type: "rewards"
		}
		parent.window.postMessage(message, "*");
		document.getElementById("signup").style.display = "block";
	}
	
	function closeRewardsSignup(){
		document.getElementById("signup").style.display = "none";
	}

	function updateReceipt(order){
		var target = document.getElementById("receipt_screen");
		if (order.items == undefined) {
			alert("I'm sorry, you have no orders at this time");
			window.history.back();
			return;
		}
			
		order.items.forEach(items =>
			target.contentWindow.postMessage(items, '*')
		);
	}
	
	function sendTip(){
		var tip = 20;
		var target = document.getElementById("receipt_screen");
		//console.log("Sending tip");
	}
	
	function openFormSplit() {
		document.getElementById("split").style.display = "block";
	}
	
	function openFormRewards() {
		document.getElementById("myForm").style.display = "block";
	}

	function closeFormRewards() {
		document.getElementById("myForm").style.display = "none";
	}
	
	function getRewards(){
		var phone = document.getElementById("phone").value;
		var today = new Date();//gets todays date to compare with customer birthday
		var month, day, year;
		if (today.getMonth()+1 < 10) {
			month = today.getMonth()+1;
			month = "0" + month;
		}
		else {
			month = today.getMonth()+1;
		}
		if (today.getDate() < 10) {
			day= "0" + today.getDate();
		}
		else {
			day = today.getDate();
		}
		
		var noPhone = document.getElementById("noPhone");//gets paragraph area to store data if there is no phone number in the system and the number of visits
		var numVisits = document.getElementById("numVisits");	
		noPhone.innerHTML="";
		numVisits.innerHTML="";
		
		var url = "http://159.89.238.181:8080/api/customers/?phone=";
		url = url.concat(phone);
		$.get(url, function(response){
			if(response == "No entries found") {
				noPhone.innerHTML = "No rewards account found.";
				numVisits.innerHTML = "";
			}
			else{
				noPhone.innerHTML="";
				response = JSON.parse(response);
				var birthday = response[0].bday.split('-');//gets birthday by year, month, and date
				var visits = response[0].visits;
				visits ++;
				visits = visits%5;//gets how many visits the person has between rewards
				if(month == birthday[1] && day == birthday[2])//if month and day match, print out birthday message
				{
					var birthday = document.getElementById("birthday");
					birthday.innerHTML = "Happy birthday! Check your email at " +  response[0].email + " for $5 off!";
				}
				if(visits == 0)//if they have 5 visits, print reward message
				{
					numVisits.innerHTML = "You have earned a free dessert! Check your email at " + response[0].email + " for your coupon on your next visit!";
				}
				else //if they have less than 5, print how many visits they have
				{
					numVisits.innerHTML = "You have " + visits + " visits. On your fifth visit, get emailed a coupon for $5 off!";
				}
				$.post(url, function(response){
					response = JSON.parse(response);
					console.log(response);
					if(response.code == 200)//hide rewards login button if rewards have been added
					{
						var login = document.getElementById("login");
						login.style.display="none";
					}
				});
			}
		});
	}
	function submitForm() {
		var phone = document.getElementById("phoneNumber").value;//gets form information
		var email = document.getElementById("email").value;
		var birthday = document.getElementById("birth").value;
		
		var url = "http://159.89.238.181:8080/api/customers/?phone=";//checks to see if phone number exists in system
		url = url.concat(parseInt(phone));
		$.get(url, function(response){
			console.log(response);
			if(response == "No entries found")//create request if rewards account does not exist and post to the backend.
			{
				let request = {
					phone: phone,
					email: email,
					bday: birthday
				};
				var url = "http://159.89.238.181:8080/api/customers/";
				request = JSON.stringify(request);
				console.log(request);
				$.post(url, request, function(message){//message is returned from the backend and alerted
					message = JSON.parse(message);
					alert(message.message);
				});
			}
			else
			{
				alert("Phone number already exists.");
			}
		});
	}
</script>
</head>

<body onload="setup()">
<div class="row">
	<div class="column-left">
		<h2>PAYMENT METHOD</h2>

		<div class="button-group2">
			<button id="select_card" onclick="openFormCreditCard(); updatePaymentMethod()">CARD</button>
			<button id="select_cash" onclick="sendCashNotification();updatePaymentMethod()">CASH</button>
			<button id="split" onclick="openFormSplit()">SPLIT</button>
		</div>
		
		<div class="credit-popup" id="creditInfo">
			<div class="credit-container">
				<h2>Credit Card Information</h2>
				
				<label for="Enter Amount to Charge"</label>
				Enter Card NUmber: <br>
				<input type="number" placeholder="xxxxxxxxxx" step=".01" id="creditInfo" required>
		
				<span id = "send-amount">
					<button type="button" class="button" id="submitAmnt-button" onclick="sendCreditCardNotification(); closeFormCreditCard()">Submit</button>
				</span>
			</div>
		</div>
		
		
		<!--Rewards Option-->
		<h2>REWARDS</h2>
		<div class="addRewards">
			<div class="rewards-button">
				<button onclick="goRewards()">SIGN UP</button>
				<button onclick="openFormRewards()" id ="current">CURRENT MEMBER</button>
			</div>
		</div>
		
		<div class="rewards-login" id="myForm">
			<form class="form-container">
				<h1>Member Login</h1>

				<label for="email"><b>Phone Number</b></label>
				<input type="number" placeholder="1234567890" id="phone" required>

				<p id = "noPhone"></p>
				<p id = "numVisits"></p>
				<p id = "birthday"></p>
				<span id = "login">
					<button type="button" class="button" onclick="getRewards()">Login</button>
				</span>
				<button type="button" class="button cancel" onclick="closeFormRewards()">Close</button>
			</form>
		</div>
		
		<div class="rewards-login" id="signup">
			<form class="form-container">
				<h1>Member Sign Up</h1>

				<!--holds form to add a new rewards member-->
				<label style = "font-family: Arial Black, Times, serif" for ="phone">Phone Number:</label><br><br>
				<input style = "margin: 0px 0px;"type="number" id="phoneNumber" name="phone" placeholder="5555555555"><br><br>

				<label style = "font-family: Arial Black, Times, serif" for ="email">Email:</label><br><br>
				<input style = "margin: 0px 0px;"type="email" id="email" name="email" placeholder="xxxx@xxxx.com"><br><br>

				<label style = "font-family: Arial Black, Times, serif" for ="birthday">Birthday:</label><br><br>
				<input style = "margin: 0px 0px;"type="date" id="birth" name="birthday"><br><br>
				
				<span id = "login">
					<button type="button" class="button" onclick="submitForm()">Sign Up</button>
				</span>
				<button type="button" class="button cancel" onclick="closeRewardsSignup()">Cancel</button>
			</form>
		</div>
		
	</div>
	
	<div class="column-right">
		<h2>RECEIPT</h2>
		
		<!--Insert an iframe for the receipt-->
		<iframe id="receipt_screen" src="customer/customer_receipt.html" style="width:95%; height:80%" ></iframe>
	</div>
</div>
</body>
</html>
